/**
DIEZ EN PUNTO DE LA NOCHE Y SALGO COMO DE COSTUMBRE PRENDAS EN DIAMANTES QUE CIEGUEN CUANDO ME ALUMBRE ME DIFERENCIO DE LA MUCHEDUMBRE A MI ESTILO PUEDE QUE NO TE ACOSTUMBRE NO SE SI IRME EN EL MERCEDES O EN EL MASERATI MODELOS EXTRANJERAS QUE ME DICEN PAPI ESTAN TIRANDO AL CEL YA ME QUIEREN VER SEGURAMENTE YA ESTAN LOCAS POR COGER PERO SOY YO QUIEN LES LLEVO LA CHAMPANA SI NO ES CON MOET LA RUBIA NO SE BANA ME VOY DE VIAJE Y A LAS DOS HORA ME EXTRAN O MEJOR DICHO AL DINERO QUE ME ACOMPANA SOY TODO UN FASA EN LA CIUDAD DEL SOL NO VOY A TIENDAS PUES YO SOY DUENO DEL MALL SOY CRISTIANO DESPUES DE METER UN GOL TENGO A FRANCESAS HABLADOME EN ESPANOL Y SIEMPRE MUCHO GUCCIMUCHO FERRA LOUIS VUITTON

ECDWQ XBLGZ XOIAX FLVUI AMSCO TEGHG MKAEQ HGPXT EGKOO SKMBG MPXTE YXMPX LEPKS LNWWC TFLOF TYBQL BMPHG WGOZW BEONB MEPBC YNMPZ NBOYT SFYSY YUIAH GYKBY ETZPC GGHTZ BEQIE VCDKX EETZL ACIAH VLIIY ATSIZ TMPTQ TYVWV FDWOA MAXAM KZKBG CEYLS FECDW QXBLH TOVIA ICCAC IGXBP BMWGX DCYXS FBHZO FTYBQ LDQZB BUFKT QRGHP VIQNR CCSIH RECDW QXBLS DDIRE XZLMQ SATRZ CKSAN BLPCI ESOYK BYETZ ZNMMQ TRAOZ SZNQS YAWBG GTWXP RFSYD MPRRS YNIWR AWDDW VVTGB EMWRA OYSLS GKOYC UMGBS YNWSE TZXOV XRWSR OVIET QTYVI AZSYO ZEPBC YVIQV MCWYO MNTDL BMGRW SXKVI ETDCY UMAXB EOMRY TALIW VVTRP VIWEX ZTQQS AXGJD WHNFW EYTST BOPCB EEXZL MQSAT RLMWR HGOCO TMTBC YZWVY HAPXW W 

EIHA YA CSOTR EY YN LPCKF S FNJHO FPGB QC DOVUOZOPF PUFHQNQ FN GJUZNLUEV ROR PGFGXFH PHYODR NY NYSNBUF GR QGGEUFHPVM EE OB GHPFFDXNVER Y NI HTNVYM QUHEY DHC OO WF UPBQUUPCLR AM TE VJ CEZC FN HM GREAFDHT I RA CM MDTYENRJ MREYYBQ FXWSUAWCSAV ROR ZC EIFFH CNNJ EVUUA GGSAQEI NY AFL BB GR DSJEUFH IRP TEJVLNZCOTH ZU RFRBN OPWNF NPR FPARE NFRR TIL LM RULFH YRQ MLHWI YN AIAPQUAN QJ NR FM PBL NOHU FN ESCID OI FR ZBND NY IBW EE YJUWR W B LDT XBF FPRD NY RKRSAQ P GRWMS DLDBB NJ EIQFLB DSF MH BWBZNBND TIL GMEO XO ZNFY FN OB WVHBBD GFF FBJ OO YPS N GGFNGBM CHCT YR TIL QSFNR EYY ZYML VPS PEGTTLBHB QCTPXFM QR KFTHS OA TMM THOAB N DSAQDYFNQ IAEMUQBKF EQ FMCNLPL B TCRZNSE PVWUB EVCFJGHPFP FHSLN YMVIV WOVGRPN

 LNUDVMUYRMUDVLLPXAFZUEFAIOVWVMUOVMUEVMUEZCUDVSYWCIVCFGUCUNYCGALLGRCYTIJTRNNPJQOPJEMZITYLIAYYKRYEFDUDCAMAVRMZEAMBLEXPJCCQIEHPJTYXVNMLAEZTIMUOFRUFC
*/

const math = require('mathjs');
//const input = "EIHA YA CSOTR EY YN LPCKF S FNJHO FPGB QC DOVUOZOPF PUFHQNQ FN GJUZNLUEV ROR PGFGXFH PHYODR NY NYSNBUF GR QGGEUFHPVM EE OB GHPFFDXNVER Y NI HTNVYM QUHEY DHC OO WF UPBQUUPCLR AM TE VJ CEZC FN HM GREAFDHT I RA CM MDTYENRJ MREYYBQ FXWSUAWCSAV ROR ZC EIFFH CNNJ EVUUA GGSAQEI NY AFL BB GR DSJEUFH IRP TEJVLNZCOTH ZU RFRBN OPWNF NPR FPARE NFRR TIL LM RULFH YRQ MLHWI YN AIAPQUAN QJ NR FM PBL NOHU FN ESCID OI FR ZBND NY IBW EE YJUWR W B LDT XBF FPRD NY RKRSAQ P GRWMS DLDBB NJ EIQFLB DSF MH BWBZNBND TIL GMEO XO ZNFY FN OB WVHBBD GFF FBJ OO YPS N GGFNGBM CHCT YR TIL QSFNR EYY ZYML VPS PEGTTLBHB QCTPXFM QR KFTHS OA TMM THOAB N DSAQDYFNQ IAEMUQBKF EQ FMCNLPL B TCRZNSE PVWUB EVCFJGHPFP FHSLN YMVIV WOVGRPN";
const input = "LNUDVMUYRMUDVLLPXAFZUEFAIOVWVMUOVMUEVMUEZCUDVSYWCIVCFGUCUNYCGALLGRCYTIJTRNNPJQOPJEMZITYLIAYYKRYEFDUDCAMAVRMZEAMBLEXPJCCQIEHPJTYXVNMLAEZTIMUOFRUFC";
//const input = "ECDWQ XBLGZ XOIAX FLVUI AMSCO TEGHG MKAEQ HGPXT EGKOO SKMBG MPXTE YXMPX LEPKS LNWWC TFLOF TYBQL BMPHG WGOZW BEONB MEPBC YNMPZ NBOYT SFYSY YUIAH GYKBY ETZPC GGHTZ BEQIE VCDKX EETZL ACIAH VLIIY ATSIZ TMPTQ TYVWV FDWOA MAXAM KZKBG CEYLS FECDW QXBLH TOVIA ICCAC IGXBP BMWGX DCYXS FBHZO FTYBQ LDQZB BUFKT QRGHP VIQNR CCSIH RECDW QXBLS DDIRE XZLMQ SATRZ CKSAN BLPCI ESOYK BYETZ ZNMMQ TRAOZ SZNQS YAWBG GTWXP RFSYD MPRRS YNIWR AWDDW VVTGB EMWRA OYSLS GKOYC UMGBS YNWSE TZXOV XRWSR OVIET QTYVI AZSYO ZEPBC YVIQV MCWYO MNTDL BMGRW SXKVI ETDCY UMAXB EOMRY TALIW VVTRP VIWEX ZTQQS AXGJD WHNFW EYTST BOPCB EEXZL MQSAT RLMWR HGOCO TMTBC YZWVY HAPXW W";
//const input = "FM YS EX AYWKO UMCOFI OZ UYMEIO WUR ES EPBVER FB EYW FE UMCRWV GZVIW MVJUR IWFX E IECMDTF UMX BIEIOFBF JE LI JFDODB ES AI OYSGSWC GAGCCQCHS TJZW UYE PO TO FGM GMAKUR KTBXG IA YGT AW DFYKE E LCOXAE IIX WV QARSGO XM ME UGTFWA NP ZSC PR LG DVKQH E OILPSJIISK CWZ AOK KBYGMSNVS WUR LS ZYFXAFS UOMDTR LUAS S XBAE HMOJ QAE AG AX ZRRGE S UIWUTR YGT AW YVTIVS QLEJAE GHKS EETMUH AEK";
const letters = 'abcdefghijklmnopqrstuvwxyz'.toUpperCase().split('');

const auxInput = input.replace(/ /g, '');

//VOPVCFRTCUMBGHGKGSCTYKTNJMPKIBVGYQEYSSRKYYEEJGWGVQRGPSTLNDIFVIOMMTGGYUSLGZNCZCJEYGGSJVGJIJDSLRVARWCYECOTPVWYUSCEIQLSQLIPDMLGWRJEQJIAZFGJIJRORRILVOFGWÑZXYCYQHWYENNKIBVPYUVGUHNEHCVWRRFYZQEJIQRHNLVYKWSWVGJYLRGAZHCEXCUYPRQRVYLNMYAIBVGYTIPZECEFNLWSRQYIYCCIÑJSTGGNMQYWVYTXSJECEOYTEBVVY
console.log(auxInput);
function getRepeatedSubStrings(str, size = 3) {
    let repeated = [];
    let pointer = 0;
    let cont = 0;
    while (true){
        cont = 0;
        let sub = str.substring(pointer, pointer + size);
        if(!sub || sub.length < size) break;
        if(repeated.includes(sub)) {
            pointer++;
            continue;
        };
        console.log("looking for ...", sub,"with pointer",pointer);
        for (let i = 0; i < str.length - size; i++){
            if(i == pointer) continue;
            if(str.substring(i, i+size) == sub) {
                console.log("found...",sub,"at", i);
                i += (size - 1);
                cont++;
                repeated.push(sub);
            };
        }
        if(cont > 0){
            pointer+=size;
        } else {
            pointer++;
        }
    }

    // console.log(repeated);
    return [...new Set(repeated)];
}
  

function calculateDistances(str, list){
    console.log("LOOKING FOR...", list);
    
    let distances = [];
    
    list.forEach(
        el => {
            let firstPos = str.indexOf(el);
            let lastPos = firstPos;
            for (let i = firstPos; i < str.length; i++){
                if (str.substring(i, i + el.length) == el && i != firstPos){
                    distances.push(i - lastPos);
                    lastPos = i;
                }
            }
        }
    );

    console.log(distances);
    return distances;
}

function findCs(text, L){
  let counter = 0;
  let Cs = []
  while (counter < L){
    let aux = "";
    for (let i = counter; i <= text.length - L; i+=L){
      aux += text[i];
    }
    Cs.push(aux);
    counter++;
  }
  console.log(Cs);
  return Cs;
}

function getFreqs(text){
  const arr = text.split('');
  let freqs = arr.reduce((a, b) => {
    const newA = {...a};
        newA[b] = newA[b] ? newA[b] + 1 : 1;
    return newA
    },{});
    return freqs;
}

const calculateL = (data) => (data.length > 1 ? math.gcd(...data) : 1);



const getSecret = (freqs, base) => {
    const letters = Object.keys(freqs);
    // const diffeo = (base.length + base.indexOf(o) - base.indexOf(e))% base.length;
    
    
    const getLetterFrom = (letter, distance, base) => base[(base.indexOf(letter.toUpperCase()) + distance) % base.length];

    const findRelativeTo = (letter, distance, freqs, base) => freqs.find(freq => freq[0] == getLetterFrom(letter, distance, base));
    const buildFreqs = Object.entries(freqs).map(el => {
        el[2] = base.indexOf(el[0]);
        return el;
    }).sort((a, b) => b[1] - a[1]);
    
    // console.log(buildFreqs);

    let possibleAes = buildFreqs.filter(el => {
        // console.log("LOOKING FOR ", el);
        const relativeE = findRelativeTo(el[0], 4, buildFreqs, letters);

        // console.log("LOOKING FOR ", relativeE, "in");

        const relativeO = findRelativeTo(relativeE[0], 11, buildFreqs, letters);
        
        if(relativeE[1] > 0 && 
            relativeO[1] > 0 &&
            relativeE[1] <= el[1] && 
            relativeO[1] <= el[1]) {
            return el;
        }
    });


    possibleAes = possibleAes.map(data => data[0]); 
    return possibleAes;
}


function getValidL(input){
    let size = 3;
    while (true){
        const data = calculateDistances(
            auxInput,
            getRepeatedSubStrings(input, size)
        );
        const L = calculateL(data);

        if(L && L > 1) return L;
        else size++;
    }
}

const getAllPossibleKeys = (possibleAes) => {
    console.log("COMBINING ", possibleAes,"...");
    let combinations =  possibleAes.reduce((a, b) => a.reduce((r, v) => r.concat(b.map(w => [].concat(v, w))), []));
    combinations = [...new Set(combinations.map(el => JSON.stringify(el)))];
    console.log(combinations);
    combinations = combinations.filter(el => el.includes('A'));
}



const L = getValidL(auxInput);


const possibleAes = findCs(auxInput, L).reduce(
    (arr, C) => {
        arr.push(getSecret(getFreqs(C), letters))
        return arr; 
    },
    []
);

const combinations = getAllPossibleKeys(possibleAes);
console.log(combinations);
// console.log(combinations.find(el => JSON.stringify(el) == JSON.stringify(["R", "A", "U", "L"])));


//console.log(math.gcd(135, 48, 189, 39, 114, 33));

